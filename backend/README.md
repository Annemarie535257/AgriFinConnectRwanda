# AgriFinConnect Rwanda — Backend

Django REST API that loads the trained ML models and exposes endpoints for the frontend.

## Setup

```bash
cd backend
python -m venv venv
# Windows:
venv\Scripts\activate
# macOS/Linux:
# source venv/bin/activate
pip install -r requirements.txt
```

Ensure the trained models exist in the project root:

- `../loan_default_risk_model/` (relative to `backend/`)
  - `feature_columns.pkl`
  - `scaler.pkl`
  - `label_encoder.pkl`
  - `loan_default_classifier.pkl`
  - `risk_score_regressor.pkl`
  - `loan_amount_regressor.pkl`
- `../saved-model/` — **Chatbot** (T5 from `Notebooks/Financial_LLM_Chatbot.ipynb`)
  - `config.json`, `tf_model.h5`, tokenizer files (`tokenizer.json`, `spiece.model`, etc.)
  - Required by `POST /api/chat/`; uses TensorFlow + Hugging Face Transformers (see `requirements.txt`).

## Run

```bash
python manage.py migrate
python manage.py runserver
```

**Create test users (farmer + microfinance):**

```bash
python manage.py createtestusers
```

This creates:
- **Farmer:** `farmer@test.agrifinconnect.rw` / `Farmer123!`
- **Microfinance:** `microfinance@test.agrifinconnect.rw` / `Microfinance123!`

Use these to log in on the Get Started page and view the dashboards.

API base: **http://localhost:8000/api/**  
**Swagger UI:** http://localhost:8000/swagger/  
**ReDoc:** http://localhost:8000/redoc/

## Auth (registration & login)

- **Admin** is created in the backend only (no public registration). Use Django admin or `createsuperuser`, then add a **UserProfile** with role `admin` for that user (or use a staff/superuser — they are treated as admin at login).
- **Farmers** and **Microfinance** can register via API; all roles (farmer, microfinance, admin) use **login** with email + password.

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/auth/register/` | Register (body: `email`, `password`, `role`: `farmer` \| `microfinance`, optional `name`) |
| POST | `/api/auth/login/` | Login (body: `email`, `password`). Returns `token` + `user` (id, email, role). |
| POST | `/api/auth/forgot-password/` | Request password reset (body: `email`). Sends reset link to email. |
| POST | `/api/auth/reset-password/` | Set new password (body: `token`, `new_password`). Token from email link. |

**Create an admin user (backend):**

```bash
python manage.py createsuperuser   # create a Django superuser (e.g. admin@example.com)
# Then in Django admin (http://localhost:8000/admin/): add UserProfile for that user with role "Admin"
# Or: staff/superuser users without a UserProfile are treated as role "admin" at login.
```

## Activity tracking (Get Started) + Admin API

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/activity/log/` | Log Get Started event (no auth). Body: `{ "event_type": "modal_opened" \| "register_clicked" \| "login_clicked", "role": "farmers" \| "microfinances" \| "admin" }` |
| GET | `/api/admin/activity/` | List Get Started events (admin token required). Query: `?limit=100` |

**Admin can view activity:**
- **Django admin:** `http://localhost:8000/admin/` → Get Started events (after `python manage.py migrate`)
- **API:** `GET /api/admin/activity/` with header `Authorization: Token <admin_token>`

## ML & Chat endpoints

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/eligibility/` | Model 1 — loan approval (body: JSON with features) |
| POST | `/api/risk/` | Model 2 — default risk score |
| POST | `/api/recommend-amount/` | Model 3 — recommended loan amount |
| POST | `/api/chat/` | Chatbot (body: `{ "message", "language": "en"\|"fr"\|"rw" }`) |

### Request bodies

- **Eligibility / Risk / Recommend-amount**: JSON with any subset of:
  - Numeric: `Age`, `AnnualIncome`, `CreditScore`, `LoanAmount`, `LoanDuration`, `DebtToIncomeRatio`, `Experience`, `NumberOfDependents`, etc.
  - Categorical: `EmploymentStatus` (`Employed` \| `Self-Employed` \| `Unemployed`), `EducationLevel` (`High School` \| `Associate` \| `Bachelor` \| `Master`), `MaritalStatus`, `HomeOwnershipStatus`, `LoanPurpose`
- Missing fields use safe defaults.

### Responses

- **Eligibility**: `{ "approved": true|false, "prediction": 0|1 }`
- **Risk**: `{ "risk_score": number, "score": number }`
- **Recommend-amount**: `{ "recommended_amount": number, "amount": number }`
- **Chat**: `{ "reply": string, "response": string }` — When `saved-model/` is present and TensorFlow/transformers are installed, the reply is generated by the fine-tuned T5 model; otherwise a short fallback message is returned.

### Testing the chatbot

1. Install dependencies (includes TensorFlow and transformers):  
   `pip install -r requirements.txt`
2. From the **project root**, ensure `saved-model/` exists (output of `Notebooks/Financial_LLM_Chatbot.ipynb`).
3. Start the server: `python manage.py runserver`
4. Call the chat API:

```bash
curl -X POST http://localhost:8000/api/chat/ -H "Content-Type: application/json" -d "{\"message\":\"How do I apply for a loan?\",\"language\":\"en\"}"
```

Or test the service in Django shell:

```bash
python manage.py shell -c "from api.chatbot_service import generate_reply; print(generate_reply('How do I apply for a loan?'))"
```

**If you see "The chatbot model is not available right now":**

- With **DEBUG=True**, the JSON response includes `chatbot_load_error` with the reason (e.g. missing `tensorflow` or `transformers`, or wrong path).
- Ensure **`saved-model/`** is at the project root (same folder as `backend/`), and that you ran **`pip install -r requirements.txt`** (which installs `tensorflow`, `transformers`, `sentencepiece`).
- Check the server console for a log line: `Failed to load chatbot model from ...`.

## CORS

The frontend (React on port 3000) is allowed via `django-cors-headers`. For other origins, add them in `config/settings.py` under `CORS_ALLOWED_ORIGINS`.
